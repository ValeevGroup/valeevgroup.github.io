<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPQC: Running MPQC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MPQC
   &#160;<span id="projectnumber">4.0.0-beta.1</span>
   </div>
   <div id="projectbrief">Massively Parallel Electronic Structure platform</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mpqcrunning.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Running MPQC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This chapter explains how to run MPQC in a variety of environments.</p>
<p>The first sections gives general information on running MPQC:</p>
<ul>
<li>
<a class="el" href="mpqcrunning.html#mpqccomline">Command Line Options</a> </li>
</ul>
<p>The final sections give specific information on running MPQC in different environments, as well as optimization hints:</p>
<ul>
<li>
<a class="el" href="mpqcrunning.html#mpqcmpi">Running on a Distributed Memory Multiprocessor with MPI</a> </li>
<li>
<a class="el" href="mpqcrunning.html#mpqcopthints">MPQC Optimization Hints</a> </li>
</ul>
<h1><a class="anchor" id="mpqccomline"></a>
Command Line Options</h1>
<p>MPQC executable can be given the following command-line options:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">option  </th><th class="markdownTableHeadNone">accept value?  </th><th class="markdownTableHeadNone">description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-i</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">The name of the input file. MPQC will attempt to parse the given input file using the JSON, XML, and INFO formats (in that order). If <code>-i</code> is not given, and no options with omitted optional values are used (e.g., <code>-D</code>), the last command-line argument that does not specify an option will be assumed to give the input file name.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-o</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">The name of the output file. The default is to send output to the console.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-p</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">The prefix for all relative file paths in the input file   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-W</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">the working directory in which to compute   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-D</code>  </td><td class="markdownTableBodyNone">optional  </td><td class="markdownTableBodyNone">unless "debugger" keyword is given in input KeyVal, create a debugger at start, with the optional argument as its JSON KeyVal input   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-v</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the version number and exit   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-w</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the warranty and exit   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-L</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the license and exit   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-k</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print all registered (KeyVal-constructible) DescribedClass classes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-h</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the usage info and exit   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-d</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">start the program and attach a debugger   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-t</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">throw if a deprecated keyword is read   </td></tr>
</table>
<h2><a class="anchor" id="mpqccomlineexamples"></a>
MPQC Usage Examples</h2>
<ol>
<li>
prints the usage info: <div class="fragment"><div class="line">mpqc -h</div></div><!-- fragment --> </li>
<li>
run MPQC using <code>input.json</code> as the input file: <div class="fragment"><div class="line">mpqc input.json</div></div><!-- fragment --> </li>
<li>
same as 2, but launches GDB upon failure: <div class="fragment"><div class="line">mpqc -D &#39;{&quot;cmd&quot;: &quot;gdb_xterm&quot;}&#39; input.json</div></div><!-- fragment --> </li>
<li>
same as 3, but <b>broken</b> since <code>-D</code> "consumes" <code>input.json</code> as its argument: <div class="fragment"><div class="line">mpqc -D input.json</div></div><!-- fragment --> </li>
<li>
fixed version of 4, <code>input.json</code> is passed via <code>-i</code>: <div class="fragment"><div class="line">mpqc -D -i input.json</div></div><!-- fragment --> </li>
<li>
same as 2, but launches LLDB at the start: <div class="fragment"><div class="line">mpqc -d -D &#39;{&quot;cmd&quot;: &quot;lldb_xterm&quot;}&#39; input.json</div></div><!-- fragment --> </li>
<li>
same as 6, but redirects output to <code>output.log</code>': <div class="fragment"><div class="line">mpqc -d -D &#39;{&quot;cmd&quot;: &quot;lldb_xterm&quot;}&#39; -o output.log input.json</div></div><!-- fragment --> </li>
</ol>
<h1><a class="anchor" id="mpqcenv"></a>
MPQC Environment Variables</h1>
<ul>
<li><code>MPQC_WORK_DIR</code>: the directory for POSIX I/O of large text/binary files; it needs to be valid in every MPI process; the default on each process is the current working directory of that MPI process</li>
</ul>
<h1><a class="anchor" id="mpqcmpi"></a>
Running on a Distributed Memory Multiprocessor with MPI</h1>
<p>Whwreas MPQC requires a high-performance MPI implementation that supports <code>MPI_THREAD_MULTIPLE</code> operation. Modern MPI implementations expose a huge number of parameters that can be controlled by user via environment variables or other means. Correct execution of MPQC with most MPI implementations usually does not require changing any parameters; the few exceptions are listed below.</p>
<h2><a class="anchor" id="mpqcmpimvapich2"></a>
MVAPICH2</h2>
<p>Environment variables <code>MV2_ENABLE_AFFINITY</code> and <code>MV2_USE_LAZY_MEM_UNREGISTER</code> must be both set to zero, e.g.: </p><div class="fragment"><div class="line">export MV2_ENABLE_AFFINITY=0</div><div class="line">export MV2_USE_LAZY_MEM_UNREGISTER=0</div></div><!-- fragment --><h1><a class="anchor" id="mpqcopthints"></a>
MPQC Optimization Hints</h1>
<p>MPQC was designed to execute correctly and efficiently on a typical platform without too much user intervention. To achieve optimal performance, however, manual tuning is necessary.</p>
<h2><a class="anchor" id="mpqcopthintsthr"></a>
Number of MADWorld Threads</h2>
<p>The total number of MADWorld threads by default is set to the number of available cores (this may be affected by whether hyperthreading is enabled or not). Of these one thread will always be used for messaging (note that this is distinct from MPI threads; modern MPI implementations will typically use one or more threads for their own messaging operations) and the rest will be used for computation. Environment variable <code>MAD_NUM_THREADS</code> can be used to control the total number of threads used by MADWorld. It is recommended to set it to the number of hardware threads that each MPI rank can access without contention (e.g. the number of cores in each physical node).</p>
<p>N.B. The actual number of threads created by MADWorld may be greater than the value given by <code>MAD_NUM_THREADS</code>, however the total number of active threads will exceed its value. This also assumes that user tasks are single-threaded (i.e. do not spin their own threads).</p>
<h2><a class="anchor" id="mpqcopthintsbuf"></a>
Communication Buffers</h2>
<p>It is recommended to increase the number and size of communication buffers used by the active messaging system of MADWorld runtime. The following environment variables can be used to control the active messaging:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Environment Variable  </th><th class="markdownTableHeadNone">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>MAD_SEND_BUFFERS</code>  </td><td class="markdownTableBodyNone">The number of buffers that track pending outgoing messages. The default value depends on the platform; <code>MAD_SEND_BUFFERS=128</code> by default for Linux and MacOS.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>MAD_RECV_BUFFERS</code>  </td><td class="markdownTableBodyNone">The number of preallocated buffers for receiving incoming messages <em>eagerly</em>. The default value is <code>MAD_RECV_BUFFERS=128</code>.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>MAD_BUFFER_SIZE</code>  </td><td class="markdownTableBodyNone">The size of each preallocated buffer for receiving incoming messages eagerly. The default is <code>MAD_RECV_BUFFERS=1.5MB</code>.   </td></tr>
</table>
<p>The most important factor for performance is the receive buffer size: TA Arrays' tiles must fit into these buffers to ensure best performance. For data that exceeds the eager buffer size a rendevous protocol will be used which will increases messaging latency and thus will can significantly impact message processing and overall performance.</p>
<h2><a class="anchor" id="mpqcopthintsmpi"></a>
MPI Ranks per node</h2>
<p>Although in an ideal scenario one MPI rank per node is optimal for intra-node communication efficiency, in practice better performance may be obtained by using more than 1 MPI rank per node. Two factor play into this: (1) communication thread performance and (2) NUMA regions. The former determines whether single communication thread can process incoming messages at a rate sufficient to keep compute threads busy. On massively multicore machines such as Intel Xeon Phi one communication thread is not sufficient, so it is better to use more 1 MPI rank per node (this is only applicable if using more than 1 node). NUMA regions also factor into this. Since MADWorld and <a class="el" href="namespace_tiled_array.html">TiledArray</a> do not assume any structure about the memory accessed by a single MPI rank, to improve memory locality in presence of NUMA regions it is recommended to create 1 MPI rank per NUMA region (e.g. 1 per socket in a multisocket CPU node, or 1 per NUMA region on Xeon Phi), and bind that rank's threads to its region. See your MPI implementation documentation for how to bind threads to NUMA regions.</p>
<h2><a class="anchor" id="mpqcopthintsblaslapack"></a>
BLAS/LAPACK Library</h2>
<p>It is recommended to use sequential BLAS/LAPACK library interfaces. N.B. It should be possible to use multithreaded versions of MKL that use Intell Thread Building Blocks (TBB) correctly assuming that MADWorld also uses TBB. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<hr>
<address>
<small>
Generated at Mon Aug 27 2018 08:29:38 for <a
href="http://www.mpqc.org">MPQC</a>
4.0.0-beta.1 using the documentation package <a
href="http://www.doxygen.org">Doxygen</a>
1.8.14.
</small>
</address>
</body>
</html>
